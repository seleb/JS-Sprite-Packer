<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Test</title>

  <style>
  /* colors: #CAD178, #D3D57C, #C7AA74, #957964; #603140*/
  html, body{
  	padding:0;
  	margin:0;
  }
  html body *{
  	font-family: Century Gothic, Arial, sans-serif;
  }

  h1{
  	background:#CAD178;
  	color:#FFF;
  	margin:0;
  	padding:0.2em;
  	text-shadow:
  	#957964 0px -2px 0px;

  	margin-bottom: 0.5em;
  }

  section{
  	display:inline-block;
  	border-radius: 0.5em;
  	border-top-left-radius: 0;
  	border-top-right-radius: 0;
  	border-bottom:5px solid #D3D57C;
  	vertical-align: top;
  }
  section h2{
  	background: #D3D57C;
  	color:#FFF;
  	padding:0.5em;
  	margin:0;
  	border-radius: 0.5em;
  	border-bottom-left-radius: 0;
  	border-bottom-right-radius: 0;
  	text-shadow:
  	#957964 0px -2px 0px;
  }

  canvas, img{
  	border:1px solid grey;
  }

  #work-area{
  	display:none;
  }
  </style>

<script>

function Sprite(_url){
	this.img = new Image();
	this.img.src = _url;
}

function MyApp(){
	this.appName = "test";
	this.canvas = document.getElementById("canvas");
	this.ctx = this.canvas.getContext("2d");
	this.ctx.imageSmoothingEnabled = false;
	this.reader = new FileReader();
	this.reader.onload = function(event){
		var sprite = new Sprite(event.target.result);
		this.canvas.width = sprite.img.width;
		this.canvas.height = sprite.img.height;
		this.ctx.drawImage(sprite.img,0,0);
		document.getElementById("input-img").src = sprite.img.src;
		this.sprite = sprite;
	}.bind(this);
}

MyApp.prototype.init = function(){
	// check for API support
	if(!(window.File && window.FileReader && window.FileList && window.Blob)){
		throw "File API unsupported";
	}
	document.getElementById("files").onchange = this.handleFileSelect.bind(this);
	console.log("initialized");
}
MyApp.prototype.renderImage = function(file){
	this.reader.readAsDataURL(file);
}
MyApp.prototype.handleFileSelect = function(event){
	event.stopPropagation();
	event.preventDefault();

	var files = event.target.files;
	var output = [];
	for(var i = 0; i < files.length; ++i){
		var f = files[i];
		console.log(f);
		output.push("<li>"+escape(f.name)+"</li>");
	}
	this.renderImage(files[0]);
}
MyApp.prototype.trim = function(){
	var imgData = this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);

	// find first non-transparent pixel from top-left
	var start = {x:imgData.width,y:imgData.height};
	for(var y = 0; y < imgData.height; ++y){
		for(var x = 0; x < imgData.width; ++x){
			var p = y*imgData.width + x;
			var a = imgData.data[p*4 + 3];
			if(a > 0 && start.x > x){
				start.x = x;
			}if(a > 0 && start.y > y){
				start.y = y;
			}
		}
	}
	console.log(start);

	// find first non-transparent pixel from bottom-right
	var end = {x:0,y:0};
	for(var y = imgData.height-1; y > 0; --y){
		for(var x = imgData.width-1; x > 0; --x){
			var p = y*imgData.width + x;
			var a = imgData.data[p*4 + 3];
			if(a > 0 && end.x < x){
				end.x = x;
			}if(a > 0 && end.y < y){
				end.y = y;
			}
		}
	}
	console.log(end);
	var size = {x: end.x+1 - start.x, y: end.y+1 - start.y};
	this.canvas.width = size.x;
	this.canvas.height = size.y;
	this.ctx.drawImage(this.sprite.img, start.x, start.y, size.x, size.y, 0,0, size.x, size.y);
	document.getElementById("output-img").src = this.canvas.toDataURL();
}


var app = null;
document.addEventListener("DOMContentLoaded", function(event) { 
app = new MyApp();
app.init();
});
</script>
</head>

<body>
<h1>JS Sprite Utility</h1>

<section>
<h2>Input</h2>
<img id="input-img" src="no_img.png"></img>
<br>
<input type="file" id="files" name="files[]" multiple/>
</section>

<section id="work-area">
<h2>Work Area</h2>
<canvas id="canvas"></canvas>
</section>

<section>
<h2>Output</h2>
<img id="output-img" src="no_img.png"></img>
<br>
<button onclick="app.trim();">Trim</button>
</section>

</body>

</html>