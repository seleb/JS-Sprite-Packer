<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Test</title>

  <style>
  html, body{
  	padding:0;
  	margin:0;
  }

  canvas{
  	border:1px solid grey;
  }
  </style>

<script>

function Sprite(_url){
	this.img = new Image();
	this.img.src = _url;
}

function MyApp(){
	this.appName = "test";
	this.canvas = document.getElementById("output");
	this.ctx = this.canvas.getContext("2d");
	this.ctx.imageSmoothingEnabled = false;
	this.reader = new FileReader();
	this.reader.onload = function(event){
		var sprite = new Sprite(event.target.result);
		this.canvas.width = sprite.img.width;
		this.canvas.height = sprite.img.height;
		this.ctx.drawImage(sprite.img,0,0);
		this.sprite = sprite;
	}.bind(this);
}

MyApp.prototype.init = function(){
	// check for API support
	if(!(window.File && window.FileReader && window.FileList && window.Blob)){
		throw "File API unsupported";
	}
	document.getElementById("files").onchange = this.handleFileSelect.bind(this);
	console.log("initialized");
}
MyApp.prototype.renderImage = function(file){
	this.reader.readAsDataURL(file);
}
MyApp.prototype.handleFileSelect = function(event){
	event.stopPropagation();
	event.preventDefault();

	var files = event.target.files;
	var output = [];
	for(var i = 0; i < files.length; ++i){
		var f = files[i];
		console.log(f);
		output.push("<li>"+escape(f.name)+"</li>");
	}
		console.log(this);
	this.renderImage(files[0]);
}
MyApp.prototype.trim = function(){
	var imgData = this.ctx.getImageData(0,0,this.canvas.width,this.canvas.height);

	// find first non-transparent pixel from top-left
	var start = {x:imgData.width,y:imgData.height};
	for(var y = 0; y < imgData.height; ++y){
		for(var x = 0; x < imgData.width; ++x){
			var p = y*imgData.width + x;
			var a = imgData.data[p*4 + 3];
			if(a > 0 && start.x > x){
				start.x = x;
			}if(a > 0 && start.y > y){
				start.y = y;
			}
		}
	}
	console.log(start);

	// find first non-transparent pixel from bottom-right
	var end = {x:0,y:0};
	for(var y = imgData.height-1; y > 0; --y){
		for(var x = imgData.width-1; x > 0; --x){
			var p = y*imgData.width + x;
			var a = imgData.data[p*4 + 3];
			if(a > 0 && end.x < x){
				end.x = x;
			}if(a > 0 && end.y < y){
				end.y = y;
			}
		}
	}
	console.log(end);
	var size = {x: end.x+1 - start.x, y: end.y+1 - start.y};
	this.ctx.clearRect(0,0, this.canvas.width, this.canvas.height);
	this.ctx.drawImage(this.sprite.img, start.x, start.y, size.x, size.y, 0,0, size.x, size.y);
}


var app = null;
document.addEventListener("DOMContentLoaded", function(event) { 
app = new MyApp();
app.init();
});
</script>
</head>

<body>
<input type="file" id="files" name="files[]" multiple/>
<br>
<canvas id="output"></canvas>
<br>
<button onclick="app.trim();">Trim</button>

</body>

</html>